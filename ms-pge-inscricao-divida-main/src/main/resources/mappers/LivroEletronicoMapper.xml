<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="LivroEletronicoDao">
    <select id="findByFilter" resultMap="resultMap">
        select DISTINCT l.ci_livro_eletronico, l.nm_livro_eletronico, l.ds_situacao_livro, l.dt_abertura_livro, l.dt_fechamento_livro
        from tb_livro_eletronico l
        inner join tb_registro_livro r ON r.cd_livro_eletronico = l.ci_livro_eletronico
        inner join tb_inscricao i ON i.ci_inscricao = r.cd_inscricao
        inner join tb_devedor d ON d.ci_devedor = i.cd_devedor
        inner join tb_corresponsavel c ON c.cd_inscricao = i.ci_inscricao

        <where>
            <if test="nomeRazaoSocial != null">
                AND UPPER(d.nm_devedor) = #{nomeRazaoSocial} OR UPPER(c.nm_corresponsavel) = #{nomeRazaoSocial}
            </if>
            <if test="numeroInscricao != null">
                AND i.nr_inscricao = #{numeroInscricao}
            </if>
            <if test="cgf != null">
                AND d.nr_cgf_devedor = #{cgf} OR c.nr_cgf_corresponsavel = #{cgf}
            </if>
            <if test="nome != null">
                AND l.nm_livro_eletronico = #{nome}
            </if>
            <if test="cpf != null">
                AND d.nr_documento_devedor = #{cpf} OR c.nr_documento_corresponsavel = #{cpf}
            </if>
            <if test="cnpj != null">
                AND c.nr_documento_corresponsavel = #{cnpj} OR d.nr_documento_devedor = #{cnpj}
            </if>
            <if test="situacao != null">
                AND l.ds_situacao_livro = #{situacao}
            </if>
            <if test="dataAbertura != null">
                AND l.dt_abertura_livro >= #{dataAbertura}
            </if>
            <if test="dataFechamento != null">
                <![CDATA[
                AND l.dt_fechamento_livro <= #{dataFechamento}
                ]]>
            </if>
            <if test="livros != null and livros.size() > 0">
                AND l.ci_livro_eletronico::VARCHAR IN
                <foreach item="item" index="index" collection="livros" open="(" separator="," close=")">
                    #{item}::VARCHAR
                </foreach>
            </if>
        </where>
    </select>

    <resultMap id="resultMap" type="br.gov.ce.pge.gestao.dto.response.LivroEletronicoFilterResponseDto">
        <result property="id" column="ci_livro_eletronico"/>
        <result property="nome" column="nm_livro_eletronico"/>
        <result property="situacao" column="ds_situacao_livro"/>
        <result property="dataAbertura" column="dt_abertura_livro"/>
        <result property="dataFechamento" column="dt_fechamento_livro"/>
    </resultMap>
</mapper>
